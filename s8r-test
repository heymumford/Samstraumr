#!/bin/bash
# s8r-test - A script for running various types of tests in the Samstraumr project

# Set colors for output
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[0;33m'
NC='\033[0m' # No Color

# Default values
TEST_TYPE="all"
VERBOSE=false

# Display help message
function show_help {
  echo "Usage: $0 [test_type] [options]"
  echo
  echo "Test Types:"
  echo "  all         - Run all tests"
  echo "  unit        - Run unit tests only"
  echo "  component   - Run component tests only"
  echo "  composite   - Run composite tests only"
  echo "  machine     - Run machine tests only"
  echo "  architecture- Run architecture tests only"
  echo "  port        - Run port interface tests only"
  echo
  echo "Options:"
  echo "  --verbose   - Display more detailed output"
  echo
  echo "Examples:"
  echo "  $0 unit     - Run unit tests"
  echo "  $0 all --verbose - Run all tests with verbose output"
}

# Parse command line arguments
for arg in "$@"; do
  case $arg in
    all|unit|component|composite|machine|architecture|port)
      TEST_TYPE=$arg
      ;;
    --verbose)
      VERBOSE=true
      ;;
    --help|-h)
      show_help
      exit 0
      ;;
    *)
      echo -e "${RED}Unknown argument: $arg${NC}"
      show_help
      exit 1
      ;;
  esac
done

# Build profile string
PROFILE_STR=""

# Add test type profile
case $TEST_TYPE in
  unit)
    PROFILE_STR="$PROFILE_STR,unit-tests"
    ;;
  component)
    PROFILE_STR="$PROFILE_STR,component-tests"
    ;;
  composite)
    # No specific profile for composite tests - use tags
    CUCUMBER_OPTS="-Dcucumber.filter.tags=@CompositeTest"
    ;;
  machine)
    # No specific profile for machine tests - use tags
    CUCUMBER_OPTS="-Dcucumber.filter.tags=@MachineTest"
    ;;
  architecture)
    PROFILE_STR="$PROFILE_STR,architecture-tests"
    ;;
  port)
    PROFILE_STR="$PROFILE_STR,port-tests"
    ;;
  all)
    PROFILE_STR="$PROFILE_STR,all-tests"
    ;;
esac

# Clean up profile string (remove leading comma if present)
if [[ $PROFILE_STR == ,* ]]; then
  PROFILE_STR="-P${PROFILE_STR:1}"
fi

# Build Maven command
MVN_CMD="mvn test $PROFILE_STR $CUCUMBER_OPTS"
if [ "$VERBOSE" = true ]; then
  MVN_CMD="$MVN_CMD -X"
fi

# Display info
echo -e "${YELLOW}Running $TEST_TYPE tests${NC}"

echo -e "${GREEN}Executing: $MVN_CMD${NC}"
eval $MVN_CMD

echo -e "${YELLOW}Test run complete${NC}"