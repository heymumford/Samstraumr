# Docker Compose configuration for local test execution
# This allows developers to run the same containerized tests locally as in CI
#
# Usage:
#   docker-compose -f docker-compose.test.yml build          # Build all test images
#   docker-compose -f docker-compose.test.yml run unit       # Run unit tests
#   docker-compose -f docker-compose.test.yml run contract   # Run contract tests
#   docker-compose -f docker-compose.test.yml run integration # Run integration tests
#   docker-compose -f docker-compose.test.yml up             # Run all tests in parallel

version: '3.8'

services:
  # Base service with common configuration
  test-base:
    build:
      context: .
      dockerfile: Dockerfile.test
      target: test-base
      cache_from:
        - test-base:latest
    image: test-base:latest
    volumes:
      # Mount source code
      - .:/workspace:ro
      # Cache Maven dependencies between runs
      - maven-cache:/root/.m2
      # Mount test results out
      - ./target:/workspace/target
    environment:
      - MAVEN_OPTS=-XX:MaxRAMPercentage=75.0 -XX:+UseG1GC
    networks:
      - test-network

  # Unit test service
  unit:
    build:
      context: .
      dockerfile: Dockerfile.test
      target: test-unit
      cache_from:
        - test-base:latest
        - test-unit:latest
    image: test-unit:latest
    depends_on:
      - test-base
    volumes:
      - .:/workspace:ro
      - maven-cache:/root/.m2
      - ./target:/workspace/target
    environment:
      - MAVEN_OPTS=-XX:MaxRAMPercentage=75.0 -XX:+UseG1GC
      - TEST_TYPE=unit
    command: ["sh", "-c", "bin/s8r-test unit --parallel"]
    networks:
      - test-network

  # Contract test service
  contract:
    build:
      context: .
      dockerfile: Dockerfile.test
      target: test-contract
      cache_from:
        - test-base:latest
        - test-contract:latest
    image: test-contract:latest
    depends_on:
      - test-base
    volumes:
      - .:/workspace:ro
      - maven-cache:/root/.m2
      - ./target:/workspace/target
    environment:
      - MAVEN_OPTS=-XX:MaxRAMPercentage=75.0 -XX:+UseG1GC
      - TEST_TYPE=contract
      - MAVEN_CLI_OPTS=--batch-mode --errors --fail-at-end --show-version
    command: ["sh", "-c", "mvn $$MAVEN_CLI_OPTS test -Dtest=RunAdapterContractTests"]
    networks:
      - test-network

  # Integration test service
  integration:
    build:
      context: .
      dockerfile: Dockerfile.test
      target: test-integration
      cache_from:
        - test-base:latest
        - test-integration:latest
    image: test-integration:latest
    depends_on:
      - test-base
    volumes:
      - .:/workspace:ro
      - maven-cache:/root/.m2
      - ./target:/workspace/target
    environment:
      - MAVEN_OPTS=-XX:MaxRAMPercentage=75.0 -XX:+UseG1GC -Xmx2g
      - TEST_TYPE=integration
    command: ["sh", "-c", "bin/s8r-test integration"]
    networks:
      - test-network

# Named volumes for caching
volumes:
  maven-cache:
    driver: local

# Network for test services
networks:
  test-network:
    driver: bridge
