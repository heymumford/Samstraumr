name: S8r CI/CD Pipeline v2 (Optimized with Test Stage Separation)
permissions:
  contents: read

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/ISSUE_TEMPLATE/**'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/ISSUE_TEMPLATE/**'
  workflow_dispatch:
    inputs:
      run_checks:
        description: 'Run all quality checks'
        type: boolean
        default: true
      run_tests:
        description: 'Run all tests'
        type: boolean
        default: true

env:
  JAVA_VERSION: '21'
  MAVEN_OPTS: '-XX:MaxRAMPercentage=75.0 -XX:+UseG1GC -XX:+UseStringDeduplication'
  MAVEN_CLI_OPTS: '--batch-mode --errors --fail-at-end --show-version'

jobs:
  ###############################################
  # Stage 1: FAST VALIDATION (5-8 min)
  # Quick checks to fail fast on basic issues
  ###############################################
  fast-validation:
    name: Fast Validation
    runs-on: ubuntu-latest
    container:
      image: maven:3.9-eclipse-temurin-21-alpine
      env:
        MAVEN_OPTS: ${{ env.MAVEN_OPTS }}
    steps:
      - name: Setup test environment
        uses: ./.github/actions/setup-test-environment
        with:
          compile: 'true'

      - name: Validate Maven structure
        run: bin/util/scripts/test/maven-structure-test.sh

      - name: Check circular dependencies
        run: bin/util/scripts/check-circular-dependencies.sh

      - name: Run quick linters
        run: |
          mvn ${{ env.MAVEN_CLI_OPTS }} checkstyle:check
          bin/util/scripts/check-todo-format.sh
          bin/util/scripts/check-imports.sh

  ###############################################
  # Stage 2: UNIT TEST GATE (4-6 min)
  # Fast unit tests - BLOCKS everything else
  ###############################################
  unit-tests:
    name: Unit Tests (@L0_Unit)
    runs-on: ubuntu-latest
    needs: fast-validation
    if: success() && (github.event_name != 'workflow_dispatch' || inputs.run_tests)
    container:
      image: maven:3.9-eclipse-temurin-21-alpine
      env:
        MAVEN_OPTS: ${{ env.MAVEN_OPTS }}
    steps:
      - name: Setup test environment
        uses: ./.github/actions/setup-test-environment

      - name: Run unit tests (parallel)
        run: bin/s8r-test unit --parallel --coverage

      - name: Archive unit test results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: unit-test-results
          path: |
            **/target/surefire-reports/
            **/target/site/jacoco/
          retention-days: 7

  ###############################################
  # Stage 3a: CONTRACT TEST GATE (3-5 min)
  # Verify adapter contracts - PARALLEL with quality
  ###############################################
  contract-tests:
    name: Contract Tests (Adapter Contracts)
    runs-on: ubuntu-latest
    needs: unit-tests
    if: success() && (github.event_name != 'workflow_dispatch' || inputs.run_tests)
    container:
      image: maven:3.9-eclipse-temurin-21-alpine
      env:
        MAVEN_OPTS: ${{ env.MAVEN_OPTS }}
    steps:
      - name: Setup test environment
        uses: ./.github/actions/setup-test-environment
        with:
          test-compile: 'true'

      - name: Run adapter contract tests
        run: |
          mvn ${{ env.MAVEN_CLI_OPTS }} test -Dtest=RunAdapterContractTests

      - name: Archive contract test results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: contract-test-results
          path: |
            **/target/surefire-reports/
            **/target/site/jacoco/
          retention-days: 7

  ###############################################
  # Stage 3b: QUALITY ANALYSIS (6-8 min)
  # Deep static analysis - PARALLEL with contracts
  ###############################################
  quality-analysis:
    name: Quality Analysis
    runs-on: ubuntu-latest
    needs: unit-tests
    if: success() && (github.event_name != 'workflow_dispatch' || inputs.run_checks)
    container:
      image: maven:3.9-eclipse-temurin-21-alpine
      env:
        MAVEN_OPTS: ${{ env.MAVEN_OPTS }}
    steps:
      - name: Setup test environment
        uses: ./.github/actions/setup-test-environment

      - name: Run PMD analysis
        run: mvn ${{ env.MAVEN_CLI_OPTS }} pmd:check

      - name: Run SpotBugs analysis
        run: mvn ${{ env.MAVEN_CLI_OPTS }} spotbugs:check

      - name: Run OWASP dependency check
        run: mvn ${{ env.MAVEN_CLI_OPTS }} org.owasp:dependency-check-maven:check

      - name: Verify architecture compliance
        run: bin/test/verify-test-suite --skip-tests --check-architecture-only --no-report

  ###############################################
  # Stage 4: INTEGRATION TEST GATE (12-15 min)
  # Component, composite, and integration tests
  ###############################################
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [contract-tests, quality-analysis]
    if: success() && (github.event_name != 'workflow_dispatch' || inputs.run_tests)
    container:
      image: maven:3.9-eclipse-temurin-21-alpine
      env:
        MAVEN_OPTS: '${{ env.MAVEN_OPTS }} -Xmx2g'
    steps:
      - name: Setup test environment
        uses: ./.github/actions/setup-test-environment

      - name: Run component tests
        run: bin/s8r-test component --parallel

      - name: Run composite tests
        run: bin/s8r-test composite --parallel

      - name: Run integration tests
        run: bin/s8r-test integration

      - name: Archive integration test results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: integration-test-results
          path: |
            **/target/surefire-reports/
            **/target/site/jacoco/
          retention-days: 7

  ###############################################
  # Stage 5: COVERAGE & PACKAGE (3-5 min)
  # Merge coverage and package artifacts
  ###############################################
  coverage-and-package:
    name: Coverage Analysis & Package
    runs-on: ubuntu-latest
    needs: integration-tests
    if: always() && (needs.unit-tests.result == 'success' || needs.contract-tests.result == 'success' || needs.integration-tests.result == 'success')
    container:
      image: maven:3.9-eclipse-temurin-21-alpine
      env:
        MAVEN_OPTS: ${{ env.MAVEN_OPTS }}
    steps:
      - name: Setup test environment
        uses: ./.github/actions/setup-test-environment

      - name: Download all test results
        uses: actions/download-artifact@v6
        with:
          path: artifacts

      - name: Merge JaCoCo coverage reports
        run: |
          mkdir -p target/site/jacoco-merged
          mvn ${{ env.MAVEN_CLI_OPTS }} jacoco:merge \
            -Djacoco.fileSets.0.directory=artifacts/ \
            -Djacoco.fileSets.0.includes=**/*.exec \
            -Djacoco.destFile=target/jacoco-merged.exec
          mvn ${{ env.MAVEN_CLI_OPTS }} jacoco:report \
            -Djacoco.dataFile=target/jacoco-merged.exec \
            -Djacoco.outputDirectory=target/site/jacoco-merged

      - name: Run coverage analysis
        run: bin/test/analyze-test-coverage --report --threshold 80

      - name: Build and package
        run: mvn ${{ env.MAVEN_CLI_OPTS }} clean package -DskipTests

      - name: Archive coverage report
        uses: actions/upload-artifact@v5
        with:
          name: coverage-report
          path: |
            target/site/jacoco-merged/
            test-coverage-analysis.md
          retention-days: 30

      - name: Archive JAR artifacts
        uses: actions/upload-artifact@v5
        with:
          name: s8r-artifacts
          path: |
            **/target/*.jar
            !**/target/original-*.jar
          retention-days: 30

  ###############################################
  # Stage 6: DEPLOY & DOCS (3-5 min)
  # Only on main branch
  ###############################################
  deploy-and-docs:
    name: Deploy & Documentation
    runs-on: ubuntu-latest
    needs: coverage-and-package
    if: success() && github.event_name == 'push' && github.ref == 'refs/heads/main'
    container:
      image: maven:3.9-eclipse-temurin-21-alpine
      env:
        MAVEN_OPTS: ${{ env.MAVEN_OPTS }}
    steps:
      - name: Setup test environment
        uses: ./.github/actions/setup-test-environment

      - name: Generate documentation
        run: bin/s8r-docs generate

      - name: Verify version consistency
        run: bin/s8r-version verify

      - name: Archive documentation
        uses: actions/upload-artifact@v5
        with:
          name: s8r-documentation
          path: site/
          retention-days: 90

  ###############################################
  # Notification - summary of pipeline results
  ###############################################
  notify:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [fast-validation, unit-tests, contract-tests, quality-analysis, integration-tests, coverage-and-package]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Prepare status summary
        run: |
          echo "## Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Fast Validation | ${{ needs.fast-validation.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.unit-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Contract Tests | ${{ needs.contract-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Quality Analysis | ${{ needs.quality-analysis.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | ${{ needs.integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Coverage & Package | ${{ needs.coverage-and-package.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.integration-tests.result }}" == "success" ]; then
            echo "✅ **All tests passed!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Pipeline failed - check logs above**" >> $GITHUB_STEP_SUMMARY
          fi
