# Base image for all CI test stages
# This uses Alpine Linux for minimal size (~200MB vs ~450MB for Ubuntu-based images)
FROM maven:3.9-eclipse-temurin-21-alpine

LABEL maintainer="Samstraumr Project"
LABEL description="Lightweight base image for CI test execution"
LABEL version="1.0.0"

# Install additional tools needed for testing
RUN apk add --no-cache \
    git \
    bash \
    curl

# Configure JVM optimizations for container environments
# - MaxRAMPercentage: Use 75% of container memory for heap
# - UseG1GC: Garbage collector optimized for containers
# - UseStringDeduplication: Reduce memory usage from duplicate strings
# - ExitOnOutOfMemoryError: Fail fast on OOM
# - Xshare:on: Enable class data sharing for faster startup
ENV MAVEN_OPTS="-XX:MaxRAMPercentage=75.0 \
                -XX:+UseG1GC \
                -XX:+UseStringDeduplication \
                -XX:+ExitOnOutOfMemoryError \
                -Xshare:on \
                -Djava.security.egd=file:/dev/./urandom"

# Create non-root user for security
RUN addgroup -g 1000 maven && \
    adduser -u 1000 -G maven -s /bin/sh -D maven

# Configure Maven for maven user
ENV MAVEN_CONFIG=/home/maven/.m2
ENV MAVEN_CLI_OPTS="--batch-mode --errors --fail-at-end --show-version"

# Create Maven and workspace directories with proper ownership
RUN mkdir -p ${MAVEN_CONFIG} /workspace && \
    chown -R maven:maven ${MAVEN_CONFIG} /workspace

# Set working directory
WORKDIR /workspace

# Switch to non-root user
USER maven

# Pre-download common Maven plugins to cache them in the layer
# This significantly speeds up subsequent builds
RUN mvn org.apache.maven.plugins:maven-help-plugin:3.4.0:evaluate \
    -Dexpression=project.version -q -DforceStdout || true

# Health check for the container
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD java -version || exit 1

# Default command (can be overridden)
CMD ["/bin/bash"]
