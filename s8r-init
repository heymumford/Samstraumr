#!/usr/bin/env bash
#==============================================================================
# s8r-init: Initialize a new Samstraumr repository
# Part of the Samstraumr project CLI tools
#==============================================================================
set -e

# Determine script directory and project root
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
export PROJECT_ROOT="${SCRIPT_DIR}"

# Source common library
source "${PROJECT_ROOT}/.s8r/lib/common.sh"

# Initialize variables
VERBOSE=false
PACKAGE=""
DEBUG=false
TARGET_DIR="$(pwd)"

# Display help information
show_help() {
  echo -e "${BOLD}Samstraumr Init${RESET} - Initialize a new Samstraumr repository"
  echo
  echo -e "${BOLD}USAGE:${RESET}"
  echo "  ./s8r init [options] [target-directory]"
  echo
  echo -e "${BOLD}OPTIONS:${RESET}"
  echo "  -h, --help                Display this help message"
  echo "  -v, --verbose             Enable verbose output"
  echo "  -p, --package <name>      Specify a custom package name (default: org.example)"
  echo "  -d, --debug               Enable debug output (additional details)"
  echo
  echo -e "${BOLD}ARGUMENTS:${RESET}"
  echo "  target-directory          Directory to initialize (default: current directory)"
  echo
  echo -e "${BOLD}EXAMPLES:${RESET}"
  echo "  ./s8r init                                # Initialize in current directory"
  echo "  ./s8r init ~/new-project                  # Initialize in ~/new-project"
  echo "  ./s8r init -p com.mycompany.project       # Use custom package name"
}

# Parse arguments
while [[ $# -gt 0 ]]; do
  case "$1" in
    -h|--help)
      show_help
      exit 0
      ;;
    -v|--verbose)
      VERBOSE=true
      shift
      ;;
    -p|--package)
      if [[ -z "$2" || "$2" == -* ]]; then
        error "Package name argument missing"
      fi
      PACKAGE="$2"
      shift 2
      ;;
    -d|--debug)
      DEBUG=true
      shift
      ;;
    *)
      if [[ -z "$TARGET_DIR" || "$TARGET_DIR" == "$(pwd)" ]]; then
        TARGET_DIR="$1"
      else
        error "Unexpected argument: $1"
      fi
      shift
      ;;
  esac
done

# Function to run Java-based initializer
run_initializer() {
  local target_dir="$1"
  local package_name="$2"
  
  # Check if Maven is available
  if ! command_exists "mvn"; then
    error "Maven is required for initialization. Please install Maven and try again."
  fi
  
  # Generate temporary classpath file
  local classpath_file="/tmp/s8r-init-classpath-$$.txt"
  
  # Load classpath for S8rInitializer
  if $VERBOSE; then
    info "Resolving classpath for S8rInitializer..."
  fi
  
  cd "${PROJECT_ROOT}"
  mvn -q dependency:build-classpath -Dmdep.outputFile="$classpath_file" -DincludeTypes=jar
  
  if [ ! -f "$classpath_file" ]; then
    error "Failed to generate classpath for initializer"
  fi
  
  # Read classpath from file
  CLASSPATH="$(<"$classpath_file"):${PROJECT_ROOT}/Samstraumr/samstraumr-core/target/classes"
  
  # Clean up temporary file
  rm -f "$classpath_file"
  
  # Prepare command arguments
  local java_args=()
  
  # Enable debugging if requested
  if $DEBUG; then
    java_args+=("-Ddebug=true")
  fi
  
  # Add system properties for initialization
  java_args+=("-Ds8r.init.target=$target_dir")
  
  # Only add package option if specified
  if [ -n "$package_name" ]; then
    java_args+=("-Ds8r.init.package=$package_name")
    
    # Run the initializer with package
    if $VERBOSE; then
      info "Running initializer with package $package_name..."
    fi
    
    # Run the command runner
    java -cp "$CLASSPATH" "${java_args[@]}" \
      org.s8r.initialization.InitCommandRunner "$target_dir" "$package_name"
  else
    # Run the initializer with default package
    if $VERBOSE; then
      info "Running initializer with default package..."
    fi
    
    # Run the command runner
    java -cp "$CLASSPATH" "${java_args[@]}" \
      org.s8r.initialization.InitCommandRunner "$target_dir"
  fi
}

# Main execution
main() {
  # Ensure the target directory exists
  if [ ! -d "$TARGET_DIR" ]; then
    if $VERBOSE; then
      info "Creating target directory: $TARGET_DIR"
    fi
    mkdir -p "$TARGET_DIR"
  fi
  
  # Convert to absolute path
  TARGET_DIR="$(cd "$TARGET_DIR" && pwd)"
  
  if $VERBOSE; then
    info "Initializing Samstraumr repository in: $TARGET_DIR"
  fi
  
  # Check if target is already a Samstraumr repository
  if [ -d "$TARGET_DIR/.s8r" ]; then
    error "Target directory already contains a Samstraumr repository"
  fi
  
  # Check if target is a git repository
  if [ ! -d "$TARGET_DIR/.git" ]; then
    info "Target is not a git repository. Initializing git..."
    
    # Initialize git repository
    (cd "$TARGET_DIR" && git init)
    
    # Create initial commit if there are no commits yet
    if ! (cd "$TARGET_DIR" && git rev-parse --verify HEAD >/dev/null 2>&1); then
      if $VERBOSE; then
        info "Creating initial git commit..."
      fi
      
      # Create dummy README for initial commit
      if [ ! -f "$TARGET_DIR/README.md" ]; then
        echo "# Temporary README" > "$TARGET_DIR/README.md"
        (cd "$TARGET_DIR" && git add README.md)
        (cd "$TARGET_DIR" && git commit -m "Initial commit")
      fi
    fi
  fi
  
  # Run the Java initializer
  if $VERBOSE; then
    info "Running Samstraumr initializer..."
  fi
  
  run_initializer "$TARGET_DIR" "$PACKAGE"
  
  success "Samstraumr repository initialized successfully at: $TARGET_DIR"
}

# Execute the main function
main